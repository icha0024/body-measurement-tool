<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Measurement Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    <style>
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            z-index: 1000;
            font-size: 1.1rem;
        }
        
        .measurement-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .measurement-card:hover {
            transform: translateY(-5px);
        }
        
        .measurement-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            color: white;
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); min-height: 100vh;">
    <div class="container-fluid py-5">
        <!-- Navigation -->
        <button id="backToHome" class="back-btn btn btn-link d-none">
            <i class="fas fa-arrow-left"></i> Back
        </button>

        <!-- Home Screen -->
        <div id="homeScreen" class="container">
            <div class="text-center mb-5">
                <h1 class="display-4 text-white mb-3">Body Measurement Tool</h1>
                <p class="lead text-white">AI-powered body measurements using your camera</p>
            </div>
            
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="measurement-card p-5">
                        <div class="text-center mb-4">
                            <img src="measurement-guide.png" alt="Measurement Guide - Shows proper posture for body measurement" class="img-fluid rounded mb-4" style="max-height: 300px;">
                        </div>

                        <h5 class="text-dark mb-3">How it works:</h5>
                        <ul class="text-dark">
                            <li><strong>Upper body positioning:</strong> Only your upper body needs to be in frame (from slightly below waist to top of head)</li>
                            <li><strong>Height reference:</strong> Enter the height of the body portion visible in your photo - NOT your full height</li>
                            <li>Uses AI to detect your body pose and calculate measurements</li>
                            <li>Measures shoulder and waist width automatically</li>
                            <li>Works with camera or uploaded photos</li>
                            <li>All processing happens in your browser after initial model download</li>
                        </ul>

                        <div class="text-center mt-4">
                            <button id="startCamera" class="btn btn-custom btn-lg px-5 py-3 me-3">
                                <i class="fas fa-camera me-2"></i>Use Camera
                            </button>
                            <button id="uploadPhoto" class="btn btn-custom btn-lg px-5 py-3 me-3">
                                <i class="fas fa-upload me-2"></i>Upload Photo
                            </button>
                            <button id="viewHistory" class="btn btn-outline-primary btn-lg px-5 py-3">
                                <i class="fas fa-history me-2"></i>View History
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Screen -->
        <div id="cameraScreen" class="container d-none">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="measurement-card p-4">
                        <h4 class="text-center mb-4">Camera Measurement</h4>
                        
                        <div class="text-center position-relative">
                            <video id="video" autoplay playsinline class="rounded w-100" style="max-height: 70vh;"></video>
                            <canvas id="canvas" class="w-100 rounded d-none" style="max-height: 70vh;"></canvas>
                            <h1 id="countdown" class="position-absolute top-50 start-50 translate-middle display-1 d-none text-white" style="text-shadow: 0 0 10px black; z-index: 1000;">5</h1>
                        </div>

                        <div id="heightInput" class="my-4 text-center d-none">
                            <label for="userHeight" class="form-label fs-5">Enter the height of your upper body shown in the photo (cm):</label>
                            <div class="d-flex justify-content-center">
                                <input type="number" id="userHeight" class="form-control form-control-lg rounded-pill px-4 mx-auto"
                                       min="50" max="250" placeholder="e.g. 85" required style="max-width: 200px;">
                            </div>
                            <button id="processPhoto" class="btn btn-custom mt-3">Process Measurement</button>
                        </div>

                        <div id="measurementResult" class="mt-4 d-none">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="measurement-item">
                                        <h6>Shoulder Width</h6>
                                        <span id="shoulderWidth" class="fs-4 fw-bold text-success">--</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="measurement-item">
                                        <h6>Waist Width</h6>
                                        <span id="waistWidth" class="fs-4 fw-bold text-success">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button id="retakePhoto" class="btn btn-secondary">Retake Photo</button>
                            <button id="saveMeasurement" class="btn btn-success d-none">Save Measurement</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Screen -->
        <div id="uploadScreen" class="container d-none">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="measurement-card p-5">
                        <h4 class="text-center mb-4">Upload Photo for Measurement</h4>
                        
                        <div class="text-center">
                            <div class="mb-4">
                                <label for="imageUpload" class="btn btn-custom btn-lg">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>Choose Image
                                </label>
                                <input type="file" id="imageUpload" accept="image/*" class="d-none">
                            </div>
                            <p class="text-muted">Select a photo where your upper body is clearly visible</p>
                        </div>

                        <div id="uploadPreview" class="text-center d-none">
                            <img id="previewImage" class="img-fluid rounded mb-3" style="max-height: 400px;">
                            
                            <div class="my-3">
                                <label for="uploadHeight" class="form-label">Height of upper body visible in photo (cm):</label>
                                <input type="number" id="uploadHeight" class="form-control mx-auto" style="max-width: 200px;" min="50" max="250" placeholder="e.g. 85">
                            </div>
                            
                            <button id="processUpload" class="btn btn-custom">Process Photo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Screen -->
        <div id="historyScreen" class="container d-none">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="measurement-card p-5">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Measurement History</h4>
                            <button id="clearHistory" class="btn btn-outline-danger">
                                <i class="fas fa-trash me-2"></i>Clear History
                            </button>
                        </div>
                        
                        <div id="historyList">
                            <p class="text-center text-muted">No measurements recorded yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BodyMeasurementTool {
            constructor() {
                this.detector = null;
                this.video = null;
                this.canvas = null;
                this.ctx = null;
                this.stream = null;
                this.countdownInterval = null;
                this.capturedImageData = null;
                this.currentMeasurement = null;
                
                this.initializeElements();
                this.setupEventListeners();
                this.loadModel();
                this.loadHistory();
            }

            initializeElements() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
            }

            setupEventListeners() {
                // Navigation
                document.getElementById('backToHome').addEventListener('click', () => this.showHome());
                document.getElementById('startCamera').addEventListener('click', () => this.showCamera());
                document.getElementById('uploadPhoto').addEventListener('click', () => this.showUpload());
                document.getElementById('viewHistory').addEventListener('click', () => this.showHistory());

                // Camera functionality
                document.getElementById('retakePhoto').addEventListener('click', () => this.retakePhoto());
                document.getElementById('processPhoto').addEventListener('click', () => this.processPhoto());
                document.getElementById('saveMeasurement').addEventListener('click', () => this.saveMeasurement());

                // Upload functionality
                document.getElementById('imageUpload').addEventListener('change', (e) => this.handleImageUpload(e));
                document.getElementById('processUpload').addEventListener('click', () => this.processUploadedImage());

                // History
                document.getElementById('clearHistory').addEventListener('click', () => this.clearHistory());
            }

            async loadModel() {
                try {
                    this.detector = await poseDetection.createDetector(
                        poseDetection.SupportedModels.MoveNet, {
                            modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
                        }
                    );
                    console.log("MoveNet model loaded successfully");
                } catch (error) {
                    console.error("Error loading model:", error);
                    alert("Failed to load AI model. Please refresh the page and try again.");
                }
            }

            showHome() {
                this.hideAllScreens();
                document.getElementById('homeScreen').classList.remove('d-none');
                document.getElementById('backToHome').classList.add('d-none');
                this.cleanup();
            }

            showCamera() {
                this.hideAllScreens();
                document.getElementById('cameraScreen').classList.remove('d-none');
                document.getElementById('backToHome').classList.remove('d-none');
                this.startCamera();
            }

            showUpload() {
                this.hideAllScreens();
                document.getElementById('uploadScreen').classList.remove('d-none');
                document.getElementById('backToHome').classList.remove('d-none');
            }

            showHistory() {
                this.hideAllScreens();
                document.getElementById('historyScreen').classList.remove('d-none');
                document.getElementById('backToHome').classList.remove('d-none');
                this.displayHistory();
            }

            hideAllScreens() {
                const screens = ['homeScreen', 'cameraScreen', 'uploadScreen', 'historyScreen'];
                screens.forEach(screen => {
                    document.getElementById(screen).classList.add('d-none');
                });
            }

            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    this.video.srcObject = this.stream;
                    this.video.classList.remove('d-none');
                    this.canvas.classList.add('d-none');
                    
                    // Start countdown after camera initializes
                    setTimeout(() => this.startCountdown(), 1000);
                } catch (error) {
                    alert('Unable to access camera. Please allow camera permission and try again.');
                    console.error('Camera error:', error);
                }
            }

            startCountdown() {
                const countdownEl = document.getElementById('countdown');
                countdownEl.classList.remove('d-none');
                let count = 5;
                
                countdownEl.textContent = count;
                
                this.countdownInterval = setInterval(() => {
                    count--;
                    countdownEl.textContent = count;
                    
                    if (count <= 0) {
                        clearInterval(this.countdownInterval);
                        countdownEl.classList.add('d-none');
                        this.capturePhoto();
                    }
                }, 1000);
            }

            capturePhoto() {
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                
                this.capturedImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                
                this.video.classList.add('d-none');
                this.canvas.classList.remove('d-none');
                document.getElementById('heightInput').classList.remove('d-none');
                
                this.stopCamera();
            }

            retakePhoto() {
                document.getElementById('heightInput').classList.add('d-none');
                document.getElementById('measurementResult').classList.add('d-none');
                document.getElementById('saveMeasurement').classList.add('d-none');
                document.getElementById('userHeight').value = '';
                
                this.startCamera();
            }

            async processPhoto() {
                const userHeight = parseFloat(document.getElementById('userHeight').value);
                
                if (!userHeight || userHeight < 50 || userHeight > 250) {
                    alert("Please enter the height of your upper body visible in the photo (between 50cm and 250cm).");
                    return;
                }

                document.getElementById('heightInput').classList.add('d-none');
                
                try {
                    const measurements = await this.analyzePose(this.canvas, userHeight);
                    if (measurements) {
                        this.displayMeasurements(measurements);
                        this.currentMeasurement = measurements;
                    }
                } catch (error) {
                    alert("Error processing photo: " + error.message);
                    console.error(error);
                }
            }

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validation
                const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
                if (!validTypes.includes(file.type)) {
                    alert("Please select a valid image file (JPEG or PNG).");
                    return;
                }

                if (file.size > 10 * 1024 * 1024) { // 10MB
                    alert("Image size is too large. Please select an image under 10MB.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        if (img.width < 400 || img.height < 400) {
                            alert("Image is too small. Please upload a larger image for accurate measurements.");
                            return;
                        }
                        
                        document.getElementById('previewImage').src = e.target.result;
                        document.getElementById('uploadPreview').classList.remove('d-none');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            async processUploadedImage() {
                const userHeight = parseFloat(document.getElementById('uploadHeight').value);
                
                if (!userHeight || userHeight < 50 || userHeight > 250) {
                    alert("Please enter the height of your upper body visible in the photo (between 50cm and 250cm).");
                    return;
                }

                const img = document.getElementById('previewImage');
                
                try {
                    const measurements = await this.analyzePose(img, userHeight);
                    if (measurements) {
                        this.displayMeasurements(measurements);
                        this.currentMeasurement = measurements;
                        
                        // Show save button
                        document.getElementById('saveMeasurement').classList.remove('d-none');
                    }
                } catch (error) {
                    alert("Error processing photo: " + error.message);
                    console.error(error);
                }
            }

            async analyzePose(imageElement, userHeight) {
                if (!this.detector) {
                    throw new Error("AI model not loaded yet. Please wait and try again.");
                }

                const poses = await this.detector.estimatePoses(imageElement);
                
                if (!poses || poses.length === 0) {
                    throw new Error("No pose detected. Please ensure your full upper body is visible.");
                }

                const keypoints = poses[0].keypoints;
                const requiredPoints = ['left_hip', 'right_hip', 'nose', 'left_shoulder', 'right_shoulder'];
                const points = {};
                
                for (const pointName of requiredPoints) {
                    const point = keypoints.find(kp => kp.name === pointName);
                    if (!point || point.score < 0.5) {
                        throw new Error(`Could not detect ${pointName} clearly. Please try with better lighting and positioning.`);
                    }
                    points[pointName] = point;
                }

                // Draw landmarks if we're using canvas
                if (imageElement.tagName === 'CANVAS') {
                    this.drawLandmarks(this.ctx, keypoints);
                }

                // Calculate measurements
                const upperBodyPixelHeight = Math.abs(points.nose.y - ((points.left_hip.y + points.right_hip.y) / 2));
                const cmPerPixel = userHeight / upperBodyPixelHeight;
                
                const waistWidthCM = Math.abs(points.left_hip.x - points.right_hip.x) * cmPerPixel;
                const shoulderWidthCM = Math.abs(points.left_shoulder.x - points.right_shoulder.x) * cmPerPixel;

                // Validate measurements
                if (waistWidthCM < 20 || waistWidthCM > 200 || shoulderWidthCM < 20 || shoulderWidthCM > 200) {
                    throw new Error("The measurements detected seem unrealistic. Please try again with a clearer photo.");
                }

                return {
                    waist: waistWidthCM.toFixed(2),
                    shoulder: shoulderWidthCM.toFixed(2),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString()
                };
            }

            drawLandmarks(ctx, keypoints) {
                const points = {};
                ['left_hip', 'right_hip', 'left_shoulder', 'right_shoulder'].forEach(name => {
                    points[name] = keypoints.find(kp => kp.name === name);
                });

                // Draw hip landmarks and line
                ctx.fillStyle = "rgba(0, 255, 0, 0.9)";
                ctx.strokeStyle = "rgba(0, 200, 0, 0.9)";
                ctx.lineWidth = 4;

                ctx.beginPath();
                ctx.arc(points.left_hip.x, points.left_hip.y, 8, 0, 2 * Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(points.right_hip.x, points.right_hip.y, 8, 0, 2 * Math.PI);
                ctx.fill();

                ctx.beginPath();
                ctx.moveTo(points.left_hip.x, points.left_hip.y);
                ctx.lineTo(points.right_hip.x, points.right_hip.y);
                ctx.stroke();

                // Draw shoulder landmarks and line
                ctx.fillStyle = "rgba(0, 0, 255, 0.9)";
                ctx.strokeStyle = "rgba(0, 0, 200, 0.9)";

                ctx.beginPath();
                ctx.arc(points.left_shoulder.x, points.left_shoulder.y, 8, 0, 2 * Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(points.right_shoulder.x, points.right_shoulder.y, 8, 0, 2 * Math.PI);
                ctx.fill();

                ctx.beginPath();
                ctx.moveTo(points.left_shoulder.x, points.left_shoulder.y);
                ctx.lineTo(points.right_shoulder.x, points.right_shoulder.y);
                ctx.stroke();

                // Add labels
                ctx.fillStyle = "black";
                ctx.font = "18px Arial";
                ctx.textAlign = "center";
                
                const waistMidX = (points.left_hip.x + points.right_hip.x) / 2;
                const waistMidY = (points.left_hip.y + points.right_hip.y) / 2 - 15;
                ctx.fillText("Waist", waistMidX, waistMidY);

                const shoulderMidX = (points.left_shoulder.x + points.right_shoulder.x) / 2;
                const shoulderMidY = (points.left_shoulder.y + points.right_shoulder.y) / 2 - 15;
                ctx.fillText("Shoulders", shoulderMidX, shoulderMidY);
            }

            displayMeasurements(measurements) {
                document.getElementById('shoulderWidth').textContent = measurements.shoulder + ' cm';
                document.getElementById('waistWidth').textContent = measurements.waist + ' cm';
                document.getElementById('measurementResult').classList.remove('d-none');
                document.getElementById('saveMeasurement').classList.remove('d-none');
            }

            saveMeasurement() {
                if (!this.currentMeasurement) return;

                const measurements = JSON.parse(localStorage.getItem('bodyMeasurements') || '[]');
                const newMeasurement = {
                    id: Date.now(),
                    ...this.currentMeasurement
                };
                
                measurements.unshift(newMeasurement);
                
                // Keep only last 50 measurements
                if (measurements.length > 50) {
                    measurements.splice(50);
                }
                
                localStorage.setItem('bodyMeasurements', JSON.stringify(measurements));
                
                alert("âœ… Measurement saved successfully!");
                this.showHistory();
            }

            loadHistory() {
                const measurements = JSON.parse(localStorage.getItem('bodyMeasurements') || '[]');
                return measurements;
            }

            displayHistory() {
                const measurements = this.loadHistory();
                const historyList = document.getElementById('historyList');
                
                if (measurements.length === 0) {
                    historyList.innerHTML = '<p class="text-center text-muted">No measurements recorded yet</p>';
                    return;
                }

                const historyHTML = measurements.map((measurement, index) => `
                    <div class="measurement-item">
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">Date</small>
                                <div>${measurement.date}</div>
                                <small class="text-muted">${measurement.time}</small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Shoulder Width</small>
                                <div class="fs-5 fw-bold text-success">${measurement.shoulder} cm</div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Waist Width</small>
                                <div class="fs-5 fw-bold text-success">${measurement.waist} cm</div>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-sm btn-outline-danger" onclick="bodyTool.deleteMeasurement(${measurement.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                historyList.innerHTML = historyHTML;
            }

            deleteMeasurement(id) {
                if (confirm('Are you sure you want to delete this measurement?')) {
                    const measurements = this.loadHistory().filter(m => m.id !== id);
                    localStorage.setItem('bodyMeasurements', JSON.stringify(measurements));
                    this.displayHistory();
                }
            }

            clearHistory() {
                if (confirm('Are you sure you want to clear all measurement history?')) {
                    localStorage.removeItem('bodyMeasurements');
                    this.displayHistory();
                }
            }

            cleanup() {
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                    this.countdownInterval = null;
                }
                this.stopCamera();
                document.getElementById('countdown').classList.add('d-none');
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
            }
        }

        // Initialize the app
        let bodyTool;
        document.addEventListener('DOMContentLoaded', () => {
            bodyTool = new BodyMeasurementTool();
        });
    </script>
</body>
</html>