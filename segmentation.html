<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Measurement Tool - Precision Mode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>
    <style>
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            z-index: 1000;
            font-size: 1.1rem;
        }
        
        .measurement-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .measurement-card:hover {
            transform: translateY(-5px);
        }
        
        .measurement-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            color: white;
        }

        .precision-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
            border-radius: 10px;
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); min-height: 100vh;">
    <div class="container-fluid py-5">
        <!-- Navigation -->
        <button id="backToHome" class="back-btn btn btn-link d-none">
            <i class="fas fa-arrow-left"></i> Back
        </button>

        <!-- Home Screen -->
        <div id="homeScreen" class="container">
            <div class="text-center mb-5">
                <h1 class="display-4 text-white mb-2">Body Measurement Tool</h1>
                <div class="precision-badge mb-3">Precision Mode</div>
                <p class="lead text-white">Advanced AI body segmentation for accurate measurements</p>
            </div>
            
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="measurement-card p-5">
                        <div class="text-center mb-4">
                            <img src="measurement-guide.png" alt="Measurement Guide - Shows proper posture for body measurement" class="img-fluid rounded mb-4" style="max-height: 300px;">
                        </div>

                        <h5 class="text-dark mb-3">Precision Measurement Features:</h5>
                        <ul class="text-dark">
                            <li><strong>True waist detection:</strong> Finds the actual narrowest point of your torso</li>
                            <li><strong>Accurate shoulder width:</strong> Measures from outer edge to outer edge</li>
                            <li><strong>Body segmentation:</strong> Uses advanced AI to detect your body outline</li>
                            <li><strong>Upper body positioning:</strong> Only your upper body needs to be in frame</li>
                            <li><strong>Height reference:</strong> Enter the height of the body portion visible in your photo</li>
                            <li>All processing happens in your browser after initial model download</li>
                        </ul>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> This version uses larger AI models (~15MB) for higher accuracy but may take longer to load initially.
                        </div>

                        <div class="text-center mt-4">
                            <button id="startCamera" class="btn btn-custom btn-lg px-5 py-3 me-3">
                                <i class="fas fa-camera me-2"></i>Use Camera
                            </button>
                            <button id="uploadPhoto" class="btn btn-custom btn-lg px-5 py-3 me-3">
                                <i class="fas fa-upload me-2"></i>Upload Photo
                            </button>
                            <button id="viewHistory" class="btn btn-outline-light btn-lg px-5 py-3">
                                <i class="fas fa-history me-2"></i>View History
                            </button>
                        </div>

                        <div class="text-center mt-3">
                            <a href="index.html" class="btn btn-outline-secondary">
                                <i class="fas fa-tachometer-alt me-2"></i>Switch to Quick Mode
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Screen -->
        <div id="cameraScreen" class="container d-none">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="measurement-card p-4 position-relative">
                        <div id="loadingOverlay" class="loading-overlay d-none">
                            <div class="text-center">
                                <div class="spinner-border mb-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div>Processing image...</div>
                            </div>
                        </div>
                        
                        <h4 class="text-center mb-4">
                            Precision Camera Measurement
                            <span class="precision-badge ms-2">Advanced AI</span>
                        </h4>
                        
                        <div class="text-center position-relative">
                            <video id="video" autoplay playsinline class="rounded w-100" style="max-height: 70vh;"></video>
                            <canvas id="canvas" class="w-100 rounded d-none" style="max-height: 70vh;"></canvas>
                            <canvas id="segmentationCanvas" class="w-100 rounded d-none" style="max-height: 70vh; opacity: 0.7; position: absolute; top: 0; left: 50%; transform: translateX(-50%);"></canvas>
                            <h1 id="countdown" class="position-absolute top-50 start-50 translate-middle display-1 d-none text-white" style="text-shadow: 0 0 10px black; z-index: 1000;">5</h1>
                        </div>

                        <div id="heightInput" class="my-4 text-center d-none">
                            <label for="userHeight" class="form-label fs-5">Enter the height of your upper body shown in the photo (cm):</label>
                            <div class="d-flex justify-content-center">
                                <input type="number" id="userHeight" class="form-control form-control-lg rounded-pill px-4 mx-auto"
                                       min="50" max="250" placeholder="e.g. 85" required style="max-width: 200px;">
                            </div>
                            <button id="processPhoto" class="btn btn-custom mt-3">Analyze Body Shape</button>
                        </div>

                        <div id="measurementResult" class="mt-4 d-none">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="measurement-item">
                                        <h6>Shoulder Width <small class="text-success">(edge-to-edge)</small></h6>
                                        <span id="shoulderWidth" class="fs-4 fw-bold text-success">--</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="measurement-item">
                                        <h6>Waist Width <small class="text-success">(narrowest point)</small></h6>
                                        <span id="waistWidth" class="fs-4 fw-bold text-success">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button id="retakePhoto" class="btn btn-secondary">Retake Photo</button>
                            <button id="saveMeasurement" class="btn btn-success d-none">Save Measurement</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Screen -->
        <div id="uploadScreen" class="container d-none">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="measurement-card p-5 position-relative">
                        <div id="uploadLoadingOverlay" class="loading-overlay d-none">
                            <div class="text-center">
                                <div class="spinner-border mb-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div>Analyzing body shape...</div>
                            </div>
                        </div>

                        <h4 class="text-center mb-4">
                            Upload Photo for Precision Measurement
                            <span class="precision-badge ms-2">Advanced AI</span>
                        </h4>
                        
                        <div class="text-center">
                            <div class="mb-4">
                                <label for="imageUpload" class="btn btn-custom btn-lg">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>Choose Image
                                </label>
                                <input type="file" id="imageUpload" accept="image/*" class="d-none">
                            </div>
                            <p class="text-muted">Select a photo where your upper body is clearly visible against a simple background</p>
                        </div>

                        <div id="uploadPreview" class="text-center d-none">
                            <img id="previewImage" class="img-fluid rounded mb-3" style="max-height: 400px;">
                            <canvas id="uploadCanvas" class="img-fluid rounded mb-3 d-none" style="max-height: 400px;"></canvas>
                            <canvas id="uploadSegmentationCanvas" class="img-fluid rounded mb-3 d-none" style="max-height: 400px; opacity: 0.7; position: absolute; top: 0; left: 50%; transform: translateX(-50%);"></canvas>
                            
                            <div class="my-3">
                                <label for="uploadHeight" class="form-label">Height of upper body visible in photo (cm):</label>
                                <input type="number" id="uploadHeight" class="form-control mx-auto" style="max-width: 200px;" min="50" max="250" placeholder="e.g. 85">
                            </div>
                            
                            <button id="processUpload" class="btn btn-custom">Analyze Body Shape</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Screen -->
        <div id="historyScreen" class="container d-none">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="measurement-card p-5">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h4>Measurement History</h4>
                                <span class="precision-badge">Precision Measurements</span>
                            </div>
                            <button id="clearHistory" class="btn btn-outline-danger">
                                <i class="fas fa-trash me-2"></i>Clear History
                            </button>
                        </div>
                        
                        <div id="historyList">
                            <p class="text-center text-muted">No precision measurements recorded yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class PrecisionMeasurementTool {
            constructor() {
                this.segmenter = null;
                this.video = null;
                this.canvas = null;
                this.ctx = null;
                this.segmentationCanvas = null;
                this.segmentationCtx = null;
                this.stream = null;
                this.countdownInterval = null;
                this.capturedImageData = null;
                this.currentMeasurement = null;
                this.isModelLoading = false;
                
                this.initializeElements();
                this.setupEventListeners();
                this.loadModel();
                this.loadHistory();
            }

            initializeElements() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.segmentationCanvas = document.getElementById('segmentationCanvas');
                this.segmentationCtx = this.segmentationCanvas.getContext('2d');
            }

            setupEventListeners() {
                // Navigation
                document.getElementById('backToHome').addEventListener('click', () => this.showHome());
                document.getElementById('startCamera').addEventListener('click', () => this.showCamera());
                document.getElementById('uploadPhoto').addEventListener('click', () => this.showUpload());
                document.getElementById('viewHistory').addEventListener('click', () => this.showHistory());

                // Camera functionality
                document.getElementById('retakePhoto').addEventListener('click', () => this.retakePhoto());
                document.getElementById('processPhoto').addEventListener('click', () => this.processPhoto());
                document.getElementById('saveMeasurement').addEventListener('click', () => this.saveMeasurement());

                // Upload functionality
                document.getElementById('imageUpload').addEventListener('change', (e) => this.handleImageUpload(e));
                document.getElementById('processUpload').addEventListener('click', () => this.processUploadedImage());

                // History
                document.getElementById('clearHistory').addEventListener('click', () => this.clearHistory());
            }

            async loadModel() {
                if (this.isModelLoading || this.segmenter) return;
                
                this.isModelLoading = true;
                                    console.log("Starting to load BodyPix model...");
                
                try {
                    // Check if bodyPix is available
                    if (typeof bodyPix === 'undefined') {
                        throw new Error("BodyPix library not loaded. Check your internet connection and try refreshing.");
                    }
                    
                    console.log("BodyPix library found, loading model...");
                    this.segmenter = await bodyPix.load({
                        architecture: 'MobileNetV1',
                        outputStride: 16,
                        multiplier: 0.75,
                        quantBytes: 2
                    });
                    console.log("BodyPix model loaded successfully!");
                } catch (error) {
                    console.error("Failed to load segmentation model:", error);
                    alert(`Failed to load AI model: ${error.message}\n\nPlease check your internet connection and refresh the page.`);
                } finally {
                    this.isModelLoading = false;
                }
            }

            showHome() {
                this.hideAllScreens();
                document.getElementById('homeScreen').classList.remove('d-none');
                document.getElementById('backToHome').classList.add('d-none');
                this.cleanup();
            }

            showCamera() {
                this.hideAllScreens();
                document.getElementById('cameraScreen').classList.remove('d-none');
                document.getElementById('backToHome').classList.remove('d-none');
                this.startCamera();
            }

            showUpload() {
                this.hideAllScreens();
                document.getElementById('uploadScreen').classList.remove('d-none');
                document.getElementById('backToHome').classList.remove('d-none');
            }

            showHistory() {
                this.hideAllScreens();
                document.getElementById('historyScreen').classList.remove('d-none');
                document.getElementById('backToHome').classList.remove('d-none');
                this.displayHistory();
            }

            hideAllScreens() {
                const screens = ['homeScreen', 'cameraScreen', 'uploadScreen', 'historyScreen'];
                screens.forEach(screen => {
                    document.getElementById(screen).classList.add('d-none');
                });
            }

            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    this.video.srcObject = this.stream;
                    this.video.classList.remove('d-none');
                    this.canvas.classList.add('d-none');
                    this.segmentationCanvas.classList.add('d-none');
                    
                    // Start countdown after camera initializes
                    setTimeout(() => this.startCountdown(), 1000);
                } catch (error) {
                    alert('Unable to access camera. Please allow camera permission and try again.');
                    console.error('Camera error:', error);
                }
            }

            startCountdown() {
                const countdownEl = document.getElementById('countdown');
                countdownEl.classList.remove('d-none');
                let count = 5;
                
                countdownEl.textContent = count;
                
                this.countdownInterval = setInterval(() => {
                    count--;
                    countdownEl.textContent = count;
                    
                    if (count <= 0) {
                        clearInterval(this.countdownInterval);
                        countdownEl.classList.add('d-none');
                        this.capturePhoto();
                    }
                }, 1000);
            }

            capturePhoto() {
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                this.segmentationCanvas.width = this.video.videoWidth;
                this.segmentationCanvas.height = this.video.videoHeight;
                
                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                this.capturedImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                
                this.video.classList.add('d-none');
                this.canvas.classList.remove('d-none');
                document.getElementById('heightInput').classList.remove('d-none');
                
                this.stopCamera();
            }

            retakePhoto() {
                document.getElementById('heightInput').classList.add('d-none');
                document.getElementById('measurementResult').classList.add('d-none');
                document.getElementById('saveMeasurement').classList.add('d-none');
                document.getElementById('userHeight').value = '';
                this.segmentationCanvas.classList.add('d-none');
                
                this.startCamera();
            }

            async processPhoto() {
                const userHeight = parseFloat(document.getElementById('userHeight').value);
                
                if (!userHeight || userHeight < 50 || userHeight > 250) {
                    alert("Please enter the height of your upper body visible in the photo (between 50cm and 250cm).");
                    return;
                }

                if (!this.segmenter) {
                    alert("AI model is still loading. Please wait a moment and try again.");
                    return;
                }

                document.getElementById('heightInput').classList.add('d-none');
                document.getElementById('loadingOverlay').classList.remove('d-none');
                
                try {
                    const measurements = await this.analyzeBodySegmentation(this.canvas, userHeight);
                    if (measurements) {
                        this.displayMeasurements(measurements);
                        this.currentMeasurement = measurements;
                        this.segmentationCanvas.classList.remove('d-none');
                    }
                } catch (error) {
                    alert("Error processing photo: " + error.message);
                    console.error(error);
                } finally {
                    document.getElementById('loadingOverlay').classList.add('d-none');
                }
            }

            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validation
                const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
                if (!validTypes.includes(file.type)) {
                    alert("Please select a valid image file (JPEG or PNG).");
                    return;
                }

                if (file.size > 10 * 1024 * 1024) { // 10MB
                    alert("Image size is too large. Please select an image under 10MB.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        if (img.width < 400 || img.height < 400) {
                            alert("Image is too small. Please upload a larger image for accurate measurements.");
                            return;
                        }
                        
                        document.getElementById('previewImage').src = e.target.result;
                        document.getElementById('uploadPreview').classList.remove('d-none');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            async processUploadedImage() {
                const userHeight = parseFloat(document.getElementById('uploadHeight').value);
                
                if (!userHeight || userHeight < 50 || userHeight > 250) {
                    alert("Please enter the height of your upper body visible in the photo (between 50cm and 250cm).");
                    return;
                }

                if (!this.segmenter) {
                    alert("AI model is still loading. Please wait a moment and try again.");
                    return;
                }

                const img = document.getElementById('previewImage');
                document.getElementById('uploadLoadingOverlay').classList.remove('d-none');
                
                try {
                    const measurements = await this.analyzeBodySegmentation(img, userHeight);
                    if (measurements) {
                        this.displayMeasurements(measurements);
                        this.currentMeasurement = measurements;
                        
                        document.getElementById('saveMeasurement').classList.remove('d-none');
                    }
                } catch (error) {
                    alert("Error processing photo: " + error.message);
                    console.error(error);
                } finally {
                    document.getElementById('uploadLoadingOverlay').classList.add('d-none');
                }
            }

            async analyzeBodySegmentation(imageElement, userHeight) {
                if (!this.segmenter) {
                    throw new Error("Segmentation model not loaded yet. Please wait and try again.");
                }

                // Get segmentation using BodyPix
                const segmentationResult = await this.segmenter.segmentPerson(imageElement);
                
                if (!segmentationResult) {
                    throw new Error("No person detected in the image. Please ensure you're clearly visible.");
                }

                const { data: maskData, width, height } = segmentationResult;
                
                // Analyze the mask to find measurements
                const measurements = this.analyzeMask(maskData, width, height, userHeight);
                
                // Visualize the segmentation
                this.visualizeSegmentation(segmentationResult, imageElement);
                
                return measurements;
            }

            analyzeMask(maskData, width, height, userHeight) {
                // Find the person's bounds
                let minX = width, maxX = 0, minY = height, maxY = 0;
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const index = y * width + x;
                        if (maskData[index] === 1) { // Person pixel in BodyPix
                            minX = Math.min(minX, x);
                            maxX = Math.max(maxX, x);
                            minY = Math.min(minY, y);
                            maxY = Math.max(maxY, y);
                        }
                    }
                }

                // Calculate body height in pixels (head to waist area)
                const bodyHeightPixels = maxY - minY;
                const cmPerPixel = userHeight / bodyHeightPixels;

                // Find shoulder width (widest point in upper 30% of body)
                const shoulderRegionHeight = Math.floor(bodyHeightPixels * 0.3);
                let maxShoulderWidth = 0;
                
                for (let y = minY; y < minY + shoulderRegionHeight; y++) {
                    let leftEdge = width, rightEdge = 0;
                    
                    for (let x = minX; x <= maxX; x++) {
                        const index = y * width + x;
                        if (maskData[index] === 1) {
                            leftEdge = Math.min(leftEdge, x);
                            rightEdge = Math.max(rightEdge, x);
                        }
                    }
                    
                    if (rightEdge > leftEdge) {
                        maxShoulderWidth = Math.max(maxShoulderWidth, rightEdge - leftEdge);
                    }
                }

                // Find waist width (narrowest point in middle 40% of body)
                const waistRegionStart = minY + Math.floor(bodyHeightPixels * 0.3);
                const waistRegionEnd = minY + Math.floor(bodyHeightPixels * 0.7);
                let minWaistWidth = width;
                
                for (let y = waistRegionStart; y < waistRegionEnd; y++) {
                    let leftEdge = width, rightEdge = 0;
                    
                    for (let x = minX; x <= maxX; x++) {
                        const index = y * width + x;
                        if (maskData[index] === 1) {
                            leftEdge = Math.min(leftEdge, x);
                            rightEdge = Math.max(rightEdge, x);
                        }
                    }
                    
                    if (rightEdge > leftEdge) {
                        const currentWidth = rightEdge - leftEdge;
                        if (currentWidth > 0) {
                            minWaistWidth = Math.min(minWaistWidth, currentWidth);
                        }
                    }
                }

                // Convert to real-world measurements
                const shoulderWidthCM = maxShoulderWidth * cmPerPixel;
                const waistWidthCM = minWaistWidth * cmPerPixel;

                // Validate measurements
                if (shoulderWidthCM < 20 || shoulderWidthCM > 200 || waistWidthCM < 15 || waistWidthCM > 200) {
                    throw new Error("The measurements detected seem unrealistic. Please try again with a clearer photo and better lighting.");
                }

                return {
                    waist: waistWidthCM.toFixed(2),
                    shoulder: shoulderWidthCM.toFixed(2),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    type: 'precision'
                };
            }

            async visualizeSegmentation(segmentationResult, originalImage) {
                const { data: maskData, width, height } = segmentationResult;
                
                const maskCanvas = document.createElement('canvas');
                const maskCtx = maskCanvas.getContext('2d');
                
                maskCanvas.width = width;
                maskCanvas.height = height;
                
                const imageData = maskCtx.createImageData(width, height);
                
                // Create colored overlay for person area
                for (let i = 0; i < maskData.length; i++) {
                    const pixelIndex = i * 4;
                    if (maskData[i] === 1) { // Person pixel in BodyPix
                        imageData.data[pixelIndex] = 40;     // R - green tint
                        imageData.data[pixelIndex + 1] = 167; // G
                        imageData.data[pixelIndex + 2] = 69;  // B
                        imageData.data[pixelIndex + 3] = 100; // A - semi-transparent
                    } else {
                        imageData.data[pixelIndex + 3] = 0; // Fully transparent
                    }
                }
                
                maskCtx.putImageData(imageData, 0, 0);
                
                // Draw on segmentation canvas
                const targetCanvas = document.getElementById('cameraScreen').classList.contains('d-none') ? 
                    document.getElementById('uploadSegmentationCanvas') : this.segmentationCanvas;
                
                if (targetCanvas) {
                    const targetCtx = targetCanvas.getContext('2d');
                    targetCanvas.width = originalImage.width || originalImage.videoWidth;
                    targetCanvas.height = originalImage.height || originalImage.videoHeight;
                    
                    targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
                    targetCtx.drawImage(maskCanvas, 0, 0, targetCanvas.width, targetCanvas.height);
                }
            }

            displayMeasurements(measurements) {
                document.getElementById('shoulderWidth').textContent = measurements.shoulder + ' cm';
                document.getElementById('waistWidth').textContent = measurements.waist + ' cm';
                document.getElementById('measurementResult').classList.remove('d-none');
                document.getElementById('saveMeasurement').classList.remove('d-none');
            }

            saveMeasurement() {
                if (!this.currentMeasurement) return;

                const measurements = JSON.parse(localStorage.getItem('precisionBodyMeasurements') || '[]');
                const newMeasurement = {
                    id: Date.now(),
                    ...this.currentMeasurement
                };
                
                measurements.unshift(newMeasurement);
                
                // Keep only last 50 measurements
                if (measurements.length > 50) {
                    measurements.splice(50);
                }
                
                localStorage.setItem('precisionBodyMeasurements', JSON.stringify(measurements));
                
                alert("âœ… Precision measurement saved successfully!");
                this.showHistory();
            }

            loadHistory() {
                const measurements = JSON.parse(localStorage.getItem('precisionBodyMeasurements') || '[]');
                return measurements;
            }

            displayHistory() {
                const measurements = this.loadHistory();
                const historyList = document.getElementById('historyList');
                
                if (measurements.length === 0) {
                    historyList.innerHTML = '<p class="text-center text-muted">No precision measurements recorded yet</p>';
                    return;
                }

                const historyHTML = measurements.map((measurement, index) => `
                    <div class="measurement-item">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <small class="text-muted">Date</small>
                                <div>${measurement.date}</div>
                                <small class="text-muted">${measurement.time}</small>
                                <div class="mt-1">
                                    <span class="badge bg-success">Precision AI</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Shoulder Width <small>(edge-to-edge)</small></small>
                                <div class="fs-5 fw-bold text-success">${measurement.shoulder} cm</div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Waist Width <small>(narrowest point)</small></small>
                                <div class="fs-5 fw-bold text-success">${measurement.waist} cm</div>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-sm btn-outline-danger" onclick="precisionTool.deleteMeasurement(${measurement.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                historyList.innerHTML = historyHTML;
            }

            deleteMeasurement(id) {
                if (confirm('Are you sure you want to delete this precision measurement?')) {
                    const measurements = this.loadHistory().filter(m => m.id !== id);
                    localStorage.setItem('precisionBodyMeasurements', JSON.stringify(measurements));
                    this.displayHistory();
                }
            }

            clearHistory() {
                if (confirm('Are you sure you want to clear all precision measurement history?')) {
                    localStorage.removeItem('precisionBodyMeasurements');
                    this.displayHistory();
                }
            }

            cleanup() {
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                    this.countdownInterval = null;
                }
                this.stopCamera();
                document.getElementById('countdown').classList.add('d-none');
                
                // Hide loading overlays
                document.getElementById('loadingOverlay').classList.add('d-none');
                document.getElementById('uploadLoadingOverlay').classList.add('d-none');
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
            }
        }

        // Initialize the precision measurement tool
        let precisionTool;
        document.addEventListener('DOMContentLoaded', () => {
            precisionTool = new PrecisionMeasurementTool();
        });
    </script>
</body>
</html>